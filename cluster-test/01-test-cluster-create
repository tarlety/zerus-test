#!/bin/bash

# assumes:
#
# - prepare "20190527-test-zerus" config/secret state for:
#   zerus-test
#   node-adm
#   ceph-adm
#   kube-adm
#   kube-apps-platform
#   kube-apps-ctrl
#
# - configure environments:
#   (zerus-test) iso
#   (node-adm) registryproxyurl
#
# - a local apt-cacher-ng server
#
# - the store location (ZSS_STORE): ~/store
#
# - gpg key without password, ex: test-zerus
#
# - kube context name: admin@test-zerus

BASECONFIG=20190527-test-zerus
APPLYLOG=${PWD}/${BASECONFIG}-apply.log
CHECKLOG=${PWD}/${BASECONFIG}-check.log
export ZSS_STORE=~/store

case $1 in
	"go")
		cd ../vboxvm
		./zss0 ssh-forward off
		./zss0 vm delete
		./zss0 network delete
		./zss0 state load config ${BASECONFIG}
		./zss0 state load secret ${BASECONFIG}
		./zss0 network create
		./zss0 vm create
		./zss0 ssh-forward on
		cd -

		cd ../../node-adm/
		./zss0 state load config ${BASECONFIG}
		./zss0 state load secret ${BASECONFIG}
		SSHPORT=$(./zss0 env | grep "SECURE_PORT" | cut -d: -f2)
		./zss0 sshclean
		./zss0 sshwait
		./zss0 sshcopy-force
		./zss0 operate on
		./zss0 apply | tee ${APPLYLOG}
		./zss0 reboot
		cd -

		cd ../vboxvm
		./zss0 ssh-forward off
		./zss0 config rsshport ${SSHPORT}
		./zss0 ssh-forward on
		cd -

		cd ../../node-adm/
		./zss0 sshwait
		./zss0 config nodectl "ssh -p ${SSHPORT}"
		./zss0 check | tee ${CHECKLOG}
		cd -

		cd ../../ceph-adm/
		./zss0 state load config ${BASECONFIG}
		./zss0 secret-create
		./zss0 preflight
		./zss0 network up
		./zss0 mon up
		./zss0 osd up
		./zss0 mds up
		./zss0 mdsmount
		cd -

		cd ../../kube-adm/
		./zss0 state load config ${BASECONFIG}
		MASTER=$(echo $(./zss0 env | grep "MASTERS" | cut -d: -f2) | cut -d' ' -f1)
		WORKER=$(echo $(./zss0 env | grep "WORKERS" | cut -d: -f2) | cut -d' ' -f1)
		MASTERIP=$(host ${MASTER} | grep address | rev | cut -d' ' -f1 | rev)
		./zss0 preflight
		./zss0 network up
		./zss0 secret-create --apiserver-advertise-address ${MASTERIP} --ignore-preflight-errors=all
		./zss0 join
		./zss0 kubecopy
		kubectl config use-context admin@test-zerus || exit 1
		cd -

		cd ../../node-adm/
		./zss0 exec ${MASTER} "sudo ufw allow from 10.0.2.2 to any proto tcp port 6443 comment 'kube-adm'"
		cd -

		cd ../vboxvm
		./zss0 kube-forward on ${MASTER}
		./zss0 web-forward on ${WORKER}
		cd -

		cd ../../kube-apps-platform/
		./zss0 state load config ${BASECONFIG}
		./zss0 state load secret ${BASECONFIG}
		./zss0 certs on
		./zss0 ing on
		cd -

		cd ../../kube-apps-ctrl/
		./app-gitea-ctrl state load config ${BASECONFIG}
		./app-gitea-ctrl init
		./app-gitea-ctrl on
		cd -

		;;
	"clean")
		cd ../../kube-adm/
		./zss0 state load config ${BASECONFIG}
		MASTER=$(echo $(./zss0 env | grep "MASTERS" | cut -d: -f2) | cut -d' ' -f1)
		WORKER=$(echo $(./zss0 env | grep "WORKERS" | cut -d: -f2) | cut -d' ' -f1)
		MASTERIP=$(host ${MASTER} | grep address | rev | cut -d' ' -f1 | rev)
		cd -

		cd ../vboxvm
		./zss0 ssh-forward off
		./zss0 vm delete
		./zss0 network delete
		./zss0 kube-forward off ${MASTER}
		./zss0 web-forward off ${WORKER}
		cd -
		;;
esac
